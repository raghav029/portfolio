<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Recorder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        .title {
            font-size: 28px;
            font-weight: bold;
            color: #333;
            margin-bottom: 30px;
        }

        .status-text {
            font-size: 18px;
            color: #666;
            margin-bottom: 20px;
        }

        .recording-text {
            color: #ff4757;
            font-weight: bold;
        }

        .timer {
            font-size: 32px;
            font-weight: bold;
            color: #ff4757;
            margin: 20px 0;
        }

        .mic-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .mic-button.idle {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .mic-button.recording {
            background: linear-gradient(135deg, #ff4757 0%, #ff3742 100%);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .mic-button:active {
            transform: scale(0.95);
        }

        .instruction {
            font-size: 14px;
            color: #999;
            margin-top: 10px;
        }

        .review-section {
            display: none;
        }

        .review-section.active {
            display: block;
        }

        .progress-container {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.1s ease;
            border-radius: 4px;
        }

        .playback-controls {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .play-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .play-button:hover {
            transform: scale(1.05);
        }

        .action-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 30px;
            gap: 10px;
        }

        .action-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .cancel-btn {
            background: #95a5a6;
            color: white;
        }

        .rerecord-btn {
            background: #f39c12;
            color: white;
        }

        .send-btn {
            background: #27ae60;
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .recording-indicator {
            width: 20px;
            height: 20px;
            background: #ff4757;
            border-radius: 50%;
            margin: 20px auto;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .error-message {
            background: #ff4757;
            color: white;
            padding: 10px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .success-message {
            background: #27ae60;
            color: white;
            padding: 10px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .loading {
            display: none;
            margin: 20px 0;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">Voice Recorder</h1>
        
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
        <div class="loading" id="loadingMessage">
            <div class="spinner"></div>
            <p>Sending voice message...</p>
        </div>

        <!-- Recording State -->
        <div id="recordingState">
            <div class="status-text" id="statusText">Hold to Record</div>
            <div class="timer" id="timer" style="display: none;">00:00</div>
            <div class="recording-indicator" id="recordingIndicator" style="display: none;"></div>
            
            <button class="mic-button idle" id="micButton">
                üé§
            </button>
            
            <div class="instruction" id="instruction">Tap and hold to record</div>
        </div>

        <!-- Review State -->
        <div class="review-section" id="reviewSection">
            <div class="status-text">Review Recording</div>
            <div class="timer" id="reviewTimer">00:00</div>
            
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            
            <div class="playback-controls">
                <button class="play-button" id="playButton">‚ñ∂Ô∏è</button>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn cancel-btn" id="cancelBtn">
                    üóëÔ∏è Cancel
                </button>
                <button class="action-btn rerecord-btn" id="rerecordBtn">
                    üîÑ Re-record
                </button>
                <button class="action-btn send-btn" id="sendBtn">
                    üì§ Send
                </button>
            </div>
        </div>
    </div>

    <script>
        class VoiceRecorder {
            constructor() {
                this.mediaRecorder = null;
                this.audioChunks = [];
                this.audioBlob = null;
                this.audioUrl = null;
                this.audio = null;
                this.isRecording = false;
                this.isPlaying = false;
                this.recordingDuration = 0;
                this.playbackPosition = 0;
                this.recordingTimer = null;
                this.playbackTimer = null;
                
                this.initializeElements();
                this.bindEvents();
                this.checkBrowserSupport();
            }

            initializeElements() {
                this.micButton = document.getElementById('micButton');
                this.statusText = document.getElementById('statusText');
                this.timer = document.getElementById('timer');
                this.instruction = document.getElementById('instruction');
                this.recordingIndicator = document.getElementById('recordingIndicator');
                this.recordingState = document.getElementById('recordingState');
                this.reviewSection = document.getElementById('reviewSection');
                this.reviewTimer = document.getElementById('reviewTimer');
                this.progressBar = document.getElementById('progressBar');
                this.playButton = document.getElementById('playButton');
                this.cancelBtn = document.getElementById('cancelBtn');
                this.rerecordBtn = document.getElementById('rerecordBtn');
                this.sendBtn = document.getElementById('sendBtn');
                this.errorMessage = document.getElementById('errorMessage');
                this.successMessage = document.getElementById('successMessage');
                this.loadingMessage = document.getElementById('loadingMessage');
            }

            bindEvents() {
                // Touch and mouse events for recording
                this.micButton.addEventListener('mousedown', () => this.startRecording());
                this.micButton.addEventListener('mouseup', () => this.stopRecording());
                this.micButton.addEventListener('mouseleave', () => this.stopRecording());
                
                this.micButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.startRecording();
                });
                this.micButton.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.stopRecording();
                });

                // Review section events
                this.playButton.addEventListener('click', () => this.togglePlayback());
                this.cancelBtn.addEventListener('click', () => this.cancelRecording());
                this.rerecordBtn.addEventListener('click', () => this.rerecord());
                this.sendBtn.addEventListener('click', () => this.sendRecording());
            }

            checkBrowserSupport() {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    this.showError('Your browser does not support audio recording');
                    return false;
                }
                return true;
            }

            async requestMicrophonePermission() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    });
                    return stream;
                } catch (error) {
                    let errorMsg = 'Microphone access denied';
                    if (error.name === 'NotAllowedError') {
                        errorMsg = 'Please allow microphone access and try again';
                    } else if (error.name === 'NotFoundError') {
                        errorMsg = 'No microphone found on your device';
                    }
                    this.showError(errorMsg);
                    throw error;
                }
            }

            async startRecording() {
                if (this.isRecording) return;

                try {
                    this.hideMessages();
                    const stream = await this.requestMicrophonePermission();
                    
                    this.audioChunks = [];
                    this.mediaRecorder = new MediaRecorder(stream, {
                        mimeType: 'audio/webm;codecs=opus'
                    });

                    this.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.audioChunks.push(event.data);
                        }
                    };

                    this.mediaRecorder.onstop = () => {
                        this.audioBlob = new Blob(this.audioChunks, { 
                            type: 'audio/webm;codecs=opus' 
                        });
                        this.audioUrl = URL.createObjectURL(this.audioBlob);
                        this.enterReviewMode();
                        
                        // Stop all tracks to release microphone
                        stream.getTracks().forEach(track => track.stop());
                    };

                    this.mediaRecorder.start(100); // Collect data every 100ms
                    this.isRecording = true;
                    this.recordingDuration = 0;
                    
                    this.updateRecordingUI();
                    this.startRecordingTimer();

                } catch (error) {
                    console.error('Error starting recording:', error);
                }
            }

            stopRecording() {
                if (!this.isRecording || !this.mediaRecorder) return;

                this.mediaRecorder.stop();
                this.isRecording = false;
                this.stopRecordingTimer();
            }

            updateRecordingUI() {
                this.micButton.className = 'mic-button recording';
                this.statusText.textContent = 'Recording...';
                this.statusText.className = 'status-text recording-text';
                this.timer.style.display = 'block';
                this.recordingIndicator.style.display = 'block';
                this.instruction.textContent = 'Release to stop';
            }

            startRecordingTimer() {
                this.recordingTimer = setInterval(() => {
                    this.recordingDuration++;
                    this.timer.textContent = this.formatTime(this.recordingDuration);
                }, 1000);
            }

            stopRecordingTimer() {
                if (this.recordingTimer) {
                    clearInterval(this.recordingTimer);
                    this.recordingTimer = null;
                }
            }

            enterReviewMode() {
                this.recordingState.style.display = 'none';
                this.reviewSection.classList.add('active');
                this.reviewTimer.textContent = this.formatTime(this.recordingDuration);
                this.progressBar.style.width = '0%';
            }

            async togglePlayback() {
                if (this.isPlaying) {
                    this.stopPlayback();
                } else {
                    await this.startPlayback();
                }
            }

            async startPlayback() {
                if (!this.audioUrl) return;

                try {
                    this.audio = new Audio(this.audioUrl);
                    this.audio.currentTime = 0;
                    
                    this.audio.addEventListener('ended', () => {
                        this.stopPlayback();
                    });

                    this.audio.addEventListener('timeupdate', () => {
                        if (this.audio && this.recordingDuration > 0) {
                            const progress = (this.audio.currentTime / this.recordingDuration) * 100;
                            this.progressBar.style.width = `${progress}%`;
                        }
                    });

                    await this.audio.play();
                    this.isPlaying = true;
                    this.playButton.textContent = '‚è∏Ô∏è';
                    
                } catch (error) {
                    console.error('Error playing audio:', error);
                    this.showError('Error playing recording');
                }
            }

            stopPlayback() {
                if (this.audio) {
                    this.audio.pause();
                    this.audio.currentTime = 0;
                    this.audio = null;
                }
                this.isPlaying = false;
                this.playButton.textContent = '‚ñ∂Ô∏è';
                this.progressBar.style.width = '0%';
            }

            cancelRecording() {
                this.cleanup();
                this.resetToIdleState();
            }

            rerecord() {
                this.cleanup();
                this.resetToIdleState();
                // Auto-start recording
                setTimeout(() => this.startRecording(), 100);
            }

            async sendRecording() {
                if (!this.audioBlob) {
                    this.showError('No recording to send');
                    return;
                }

                try {
                    this.showLoading();
                    
                    const formData = new FormData();
                    formData.append('audio', this.audioBlob, 'voice_message.webm');
                    formData.append('user_id', 'user123'); // Replace with actual user ID
                    formData.append('timestamp', Date.now().toString());
                    formData.append('duration', this.recordingDuration.toString());

                    // Replace with your backend URL
                    const response = await fetch('http://192.168.1.3:3000/upload-voice', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        this.showSuccess('Voice message sent successfully!');
                        // Send success message to Flutter
                        this.postMessageToFlutter('audio_sent', { success: true });
                    } else {
                        throw new Error(`Server error: ${response.status}`);
                    }

                } catch (error) {
                    console.error('Error sending audio:', error);
                    this.showError('Failed to send voice message');
                    this.postMessageToFlutter('audio_sent', { success: false, error: error.message });
                } finally {
                    this.hideLoading();
                    setTimeout(() => {
                        this.cleanup();
                        this.resetToIdleState();
                    }, 2000);
                }
            }

            postMessageToFlutter(type, data) {
                // For Flutter WebView communication
                if (window.flutter_inappwebview) {
                    window.flutter_inappwebview.callHandler('audioMessage', {
                        type: type,
                        data: data
                    });
                }
                
                // For debugging in regular browser
                console.log('Message to Flutter:', { type, data });
            }

            cleanup() {
                this.stopPlayback();
                if (this.audioUrl) {
                    URL.revokeObjectURL(this.audioUrl);
                    this.audioUrl = null;
                }
                this.audioBlob = null;
                this.audioChunks = [];
            }

            resetToIdleState() {
                this.recordingState.style.display = 'block';
                this.reviewSection.classList.remove('active');
                this.micButton.className = 'mic-button idle';
                this.statusText.textContent = 'Hold to Record';
                this.statusText.className = 'status-text';
                this.timer.style.display = 'none';
                this.recordingIndicator.style.display = 'none';
                this.instruction.textContent = 'Tap and hold to record';
                this.recordingDuration = 0;
                this.hideMessages();
            }

            formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }

            showError(message) {
                this.errorMessage.textContent = message;
                this.errorMessage.style.display = 'block';
                setTimeout(() => this.hideMessages(), 5000);
            }

            showSuccess(message) {
                this.successMessage.textContent = message;
                this.successMessage.style.display = 'block';
            }

            showLoading() {
                this.loadingMessage.style.display = 'block';
            }

            hideLoading() {
                this.loadingMessage.style.display = 'none';
            }

            hideMessages() {
                this.errorMessage.style.display = 'none';
                this.successMessage.style.display = 'none';
            }
        }

        // Initialize the voice recorder when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new VoiceRecorder();
        });

        // Handle page visibility for cleanup
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && window.voiceRecorder) {
                window.voiceRecorder.cleanup();
            }
        });
    </script>
</body>
</html>